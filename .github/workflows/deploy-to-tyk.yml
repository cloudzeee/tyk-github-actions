name: Deploy to Tyk

on:
  push:
    branches: [ main ]
    paths:
      - 'api-definitions/**'
      - 'policies/**'
  workflow_dispatch:

jobs:
  deploy-to-tyk:
    runs-on: self-hosted
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
    
    - name: Check Tyk services
      run: |
        echo "Checking Tyk services..."
        
        # Simple check without timeout
        if curl -f -s http://localhost:3000/hello; then
          echo "✅ Tyk Dashboard is responding"
        else
          echo "❌ Tyk Dashboard not responding"
          echo "Please start your Tyk services first"
          exit 1
        fi
        
        if curl -f -s http://localhost:8080/hello; then
          echo "✅ Tyk Gateway is responding"
        else
          echo "❌ Tyk Gateway not responding"
          echo "Please start your Tyk Gateway first"
          exit 1
        fi
    
    - name: Deploy APIs
      run: |
        echo "Deploying API definitions..."
        echo "Files found:"
        ls -la api-definitions/
        
        for file in api-definitions/*.json; do
          if [ -f "$file" ]; then
            echo "Processing $(basename $file)..."
            cat "$file"
            echo "---"
          fi
        done
