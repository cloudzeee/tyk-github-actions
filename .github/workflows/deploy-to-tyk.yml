name: Deploy API to Tyk

on:
  workflow_dispatch:

jobs:
  deploy:
    runs-on: self-hosted
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Deploy simple-api to Tyk
        run: |
          echo "Starting API deployment..."
          echo "Deploying simple-api..."
          
          RESPONSE=$(curl -s -o response.json -w "%{http_code}" \
            -H "Authorization: $TYK_AUTH" \
            -H "Content-Type: application/json" \
            -X POST http://localhost:3000/api/apis \
            -d @simple-api.json)

          echo "Response Code: $RESPONSE"
          cat response.json

          if [ "$RESPONSE" -ne 200 ]; then
            echo "‚ùå Failed to deploy simple-api"
            exit 1
          fi
        env:
          TYK_AUTH: ${{ secrets.TYK_AUTH }}
