name: Deploy to Tyk

on:
  push:
    branches: [ main ]  # Trigger on ANY push to main
  workflow_dispatch:    # Also allow manual trigger

jobs:
  deploy-to-tyk:
    runs-on: self-hosted
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
    
    - name: Check if APIs exist
      run: |
        echo "Checking for API definitions..."
        if ls api-definitions/*.json 1> /dev/null 2>&1; then
          echo "✅ Found API definitions to deploy"
        else
          echo "ℹ️  No API definitions found - creating example"
          mkdir -p api-definitions
          exit 0
        fi
    
    - name: Check Tyk services
      run: |
        echo "Checking Tyk services..."
        
        if curl -f -s http://localhost:3000/hello > /dev/null 2>&1; then
          echo "✅ Tyk Dashboard is responding"
        else
          echo "❌ Tyk Dashboard not responding"
          echo "Please start your Tyk services first"
          exit 1
        fi
        
        if curl -f -s http://localhost:8080/hello > /dev/null 2>&1; then
          echo "✅ Tyk Gateway is responding"  
        else
          echo "❌ Tyk Gateway not responding"
          exit 1
        fi
    
    - name: List API files
      run: |
        echo "API definition files:"
        ls -la api-definitions/ || echo "No api-definitions folder"
