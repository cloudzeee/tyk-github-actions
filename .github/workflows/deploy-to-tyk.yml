name: Deploy to Tyk

on:
  push:
    branches: [ main ]
    paths:
      - 'api-definitions/**'
      - 'policies/**'
  workflow_dispatch:

jobs:
  deploy-to-tyk:
    runs-on: self-hosted
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
    
    - name: Check Tyk services
      run: |
        echo "Checking Tyk services..."
        
        # Check Dashboard (macOS compatible)
        if curl -f -s ${{ secrets.TYK_LOCAL_DASHBOARD_URL }}/hello > /dev/null 2>&1; then
          echo "‚úÖ Tyk Dashboard is responding"
        else
          echo "‚ùå Tyk Dashboard not responding at ${{ secrets.TYK_LOCAL_DASHBOARD_URL }}"
          echo "Make sure your Tyk services are running locally"
          exit 1
        fi
        
        # Check Gateway
        if curl -f -s ${{ secrets.TYK_LOCAL_GATEWAY_URL }}/hello > /dev/null 2>&1; then
          echo "‚úÖ Tyk Gateway is responding"
        else
          echo "‚ùå Tyk Gateway not responding at ${{ secrets.TYK_LOCAL_GATEWAY_URL }}"
          echo "Make sure your Tyk Gateway is running locally"
          exit 1
        fi
    
    - name: Validate API definitions
      run: |
        echo "Validating API definitions..."
        
        for file in api-definitions/*.json; do
          if [ -f "$file" ]; then
            if python3 -m json.tool "$file" > /dev/null 2>&1; then
              echo "‚úÖ $(basename $file) is valid JSON"
            else
              echo "‚ùå $(basename $file) is invalid JSON"
              exit 1
            fi
          fi
        done
    
    - name: Deploy APIs
      run: |
        echo "Deploying API definitions..."
        
        for file in api-definitions/*.json; do
          if [ -f "$file" ]; then
            echo "Deploying $(basename $file)..."
            
            # Replace ORG_ID placeholder
            temp_file=$(mktemp)
            sed "s/REPLACE_WITH_YOUR_ORG_ID/${{ secrets.TYK_LOCAL_ORG_ID }}/g" "$file" > "$temp_file"
            
            # Deploy to Tyk
            response=$(curl -s -w "%{http_code}" -o /tmp/response.json \
              -X POST \
              -H "Authorization: ${{ secrets.TYK_LOCAL_API_KEY }}" \
              -H "Content-Type: application/json" \
              -d @"$temp_file" \
              "${{ secrets.TYK_LOCAL_DASHBOARD_URL }}/api/apis")
            
            http_code=$(tail -n1 <<< "$response")
            
            if [[ $http_code == "200" || $http_code == "201" ]]; then
              echo "‚úÖ Successfully deployed $(basename $file)"
            else
              echo "‚ùå Failed to deploy $(basename $file) - HTTP $http_code"
              echo "Response:"
              cat /tmp/response.json
              exit 1
            fi
            
            rm -f "$temp_file"
          fi
        done
    
    - name: Reload Gateway
      run: |
        echo "Reloading Tyk Gateway..."
        reload_response=$(curl -s -w "%{http_code}" -o /tmp/reload.json \
          -X GET \
          -H "Authorization: ${{ secrets.TYK_LOCAL_API_KEY }}" \
          "${{ secrets.TYK_LOCAL_DASHBOARD_URL }}/api/reload/group")
        
        reload_code=$(tail -n1 <<< "$reload_response")
        
        if [[ $reload_code == "200" ]]; then
          echo "‚úÖ Gateway reloaded successfully"
        else
          echo "‚ö†Ô∏è  Reload returned HTTP $reload_code"
        fi
    
    - name: Test deployed API
      run: |
        echo "Testing deployed API..."
        sleep 3
        
        # Test API (should return 401 without key)
        test_response=$(curl -s -w "%{http_code}" -o /dev/null \
          "${{ secrets.TYK_LOCAL_GATEWAY_URL }}/my-first-api/get" 2>/dev/null || echo "000")
        
        if [[ $test_response == "401" ]]; then
          echo "‚úÖ API is secured and working (401 Unauthorized as expected)"
        elif [[ $test_response == "200" ]]; then
          echo "‚úÖ API is working and accessible"
        else
          echo "‚ö†Ô∏è  API test returned HTTP $test_response"
        fi
        
        echo "üéâ Deployment completed!"